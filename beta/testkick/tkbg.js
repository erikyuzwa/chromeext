var TestkickBG=TestkickBG||{recording:!1,records:[],recordingTab:null,server:{base:"https://testkick.com",new_key:"/extension_new",main:"/extension_main",help:"/extension_help",api:"/api/v1",tests:"/tests/"},config:{},start:function(){this.findInLocalStorage("tk_config","config")},setConfig:function(a){for(var b in a)TestkickBG.config[b]=a[b];this.saveCurrentConfig()},saveCurrentConfig:function(){TestkickBG.saveToLocalStorage({tk_config:TestkickBG.config})},saveToLocalStorage:function(a){chrome.storage.local.set(a,
function(){chrome.storage.local.get(null,function(a){})})},findInLocalStorage:function(a,b){var c=this;chrome.storage.local.get(a,function(d){c[b]="undefined"!=typeof d&&"undefined"!=typeof d[a]?d[a]||{}:{}})},eraseRecords:function(){this.records=[]},toggleRecord:function(){var a=this;this.recording?(this.recordingTab=null,this.updateContextMenu(!1),chrome.browserAction.setBadgeText({text:""})):chrome.tabs.query({active:!0,currentWindow:!0},function(b){a.recordingTab=b[0].id;chrome.browserAction.setBadgeText({text:"rec"});
a.updateContextMenu(!0)});this.recording=!this.recording;this.sendMessage({action:"toggleRecord"})},getUrl:function(a){return this.server.base+this.server[a]},updateContextMenu:function(a){chrome.contextMenus&&chrome.contextMenus.update("TestkickContextMenu",{enabled:a})},messageHandler:function(a,b,c){if(a.query)return this.queryHandler(a.query,b,c);if(a.action)return this.actionHandler(a.action,b,c);a.event&&this.recordedEventHandler(a.event,b,c)},queryHandler:function(a,b,c){var d=this.recording;
b.tab.id!=this.recordingTab&&(d=!1);switch(a){case "isrecording":c({isrecording:d})}},actionHandler:function(a){switch(a){case "record":return this.recordAction();case "export":this.exportRecords()}},recordedEventHandler:function(a){this.records.push(a)},loadScript:function(a,b){var c=document.createElement("script");a.id=a.split(".")[0];c.src=chrome.extension.getURL(a);c.addEventListener("load",b,!1);document.head.appendChild(c)},sendMessage:function(a){chrome.tabs.query({active:!0,currentWindow:!0},
function(b){chrome.tabs.sendMessage(b[0].id,a,function(a){})})},saveTest:function(a){var b={};b.name=a;b.key=this.config.apiKey;b.data=this.records;return $.ajax({url:this.server.base+this.server.api+this.server.tests,type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})},getTestkickKey:function(){return this.config.apiKey||""},contextClick:function(a,b){var c=this;"Assert"==a.menuItemId&&a.selectionText&&chrome.tabs.query({active:!0,currentWindow:!0},
function(a){chrome.tabs.sendMessage(a[0].id,{action:"getSelection"},function(a){"undefined"!=typeof a&&"getSelection"==a.dataFor&&c.recordedEventHandler(a.obj)})})}};chrome.runtime.onMessage.addListener(function(a,b,c){if(!a.dataFor)return TestkickBG.messageHandler(a,b,c),!0});
var parent=chrome.contextMenus.create({id:"TestkickContextMenu",title:"TestKick",contexts:["all","selection"],enabled:!1}),testChild=chrome.contextMenus.create({id:"Assert",title:"Assert for '%s'",parentId:"TestkickContextMenu",contexts:["selection"]});chrome.contextMenus.onClicked.addListener(function(a,b){TestkickBG.contextClick(a,b)});chrome.browserAction.onClicked.addListener(function(a){console.log("wake up")});TestkickBG.start();window.testkickBG=TestkickBG;
